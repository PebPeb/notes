
# Petalinux

## Setting up Petalinux in Ubuntu 18.04.4 VM

``` bash
sudo apt install gawk
sudo apt-get install net-tools xterm autoconf libtool texinfo zlib1g-dev gcc-multilib build-essential libncurses5-dev zlib1g:i386
./petalinux-v2022.1-04191534-installer.run
sudo dpkg-reconfigure dash                                        # Select NO
```

...

## Using Petalinux 

Default username: petalinux

## Petalinux Commands

In total there are only 6 petalinux commands.

``` bash
petalinux-create
petalinux-config
petalinux-build
petalinux-boot
petalinux-package
petalinux-util
```

### Build Commands Example

``` bash
petalinux-create -t project -n <prj_name> --template zynq          # Starting petalinux project for Zynq
petalinux-config --get-hw-description=<.xsa>                       # Hardware description file generated by Vivado
petalinux-config -c kernel                                         # ¯\_(ツ)_/¯
petalinux-config -c rootfs
petalinux-build                                                    # Building project
petalinux-package --boot --fsbl zynq_fsbl.elf --u-boot --fpga system.bit --force
petalinux-boot --qemu --kernel
```
**note**
Make sure in `petalinux-config` the YOCTO_MACHINE_NAME is correct.
  - zcu111: *xilinx-zcu111*
  - Zybo Z7-20: *zynq-generic*

``` bash
petalinux-create -t modules \--name mymodule \--enable
petalinux-build -c mymodule
petalinux-build -c mymodule -x do_clean                               # For compiling .ko
petalinux-package --bsp -p . -o <output.bsp> --hwsource <hw.xsa>
```
./build/tmp/sysroots-components/zynq_generic/mymodule/lib/modules/5.15.19-xilinx-v2022.1/extra/mymodule.ko

## Helpful commands 

``` bash
lsblk                                        # Shows add drives in linux
lsblk -f                                     # Includes formating
mount <drive> <folder>
mount -t <format> <drive> <folder>
  vfat                                       # fat32
  ext4                                       # ext4
tar -xzvf <.tar.gz> -C <folder>              # Untars the .tar.gz into <folder>

ifconfig eth0 <ip> netmask <netmask>
```

## Boot SD Card

(partition names don't matter)

Disk
.
+-- _boot(fat32)
|   +-- BOOT.BIN
|   +-- boot.scr
|   +-- image.ub
+-- _root(ext4)
|   +-- <extracted rootfs.tar.gz>




## Directory Documentation

Petalinux Project
.
+-- build
+-- components
+-- images
+-- project-specs
+-- config.project

### build 

build
.
+-- bitbake-cookerdaemon.log
+-- build.log
+-- build.log.old
+-- cache
+-- conf
+-- config.log
+-- config.log.old
+-- downloads
+-- misc
+-- package.log
+-- package.log.old
+-- sstate-cache
+-- tmp


## Flashing already running board with new .bin

FPGA manager must be enabled for this to work. All the needed files for this process should be provided in the `images/linux` build directory.

``` bash
# Also need to add the device tree overlay
echo <fpga.bin> > /sys/class/fpga_manager/fpga0/firmware
```

Flashing the board and adding the new device tree blob overlay

``` bash
# Clear the flag
sudo sh -c "echo 0 > /sys/class/fpga_manager/fpga0/flags"

# Configure folders
sudo mkdir -p /lib/firmware
sudo cp *.dtbo /lib/firmware/
sudo cp *.bit.bin /lib/firmware/

sudo mkdir /configfs
sudo mount -t configfs configfs /configfs
sudo mkdir /configfs/device-tree/overlays/full

# Adding new overlay for linux
sudo sh -c "echo -n /home/zcu111/pl.dtbo > /configfs/device-tree/overlays/full/path"
# Flashing FPGA with new bin
sudo sh -c "echo system.bit.bin > /sys/class/fpga_manager/fpga0/firmware"
```

### Building the .bin

``` bash
bootgen -image Full_Bitstream.bif -arch zynqmp -process_bitstream bin
```

Full_Bitstream.bif file contains:
``` 
all:
{
  system.bit
}
```

### Rebuilding the pl.dtbo

``` bash
petalinux-config --get-hw-description=<.xsa> 
petalinux-build -c device-tree
```

#### tmp

The `temp` folder is used for holding the files generated by Yocto. In that folder there is a `work` and `work-shared` both of these folders hold the kernel for the system. The `work-shared` folder holds the generic kernel files used by most of all system. Where as the `work` folder holds the specific files of the kernel for the system. There for majority of the kernel is in the `work-shared` with a small amount in the `work`.
